<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>AAR SoirÃ©e â€” Live Rules V13 (stable)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root { --brand:#0a7be7; --bg:#f6f7f9; --card:#fff; --muted:#666; --border:#d9dfe6; --ok:#22a06b; --warn:#c97a00; --copy:#0a7be7; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Segoe UI,system-ui,-apple-system,Arial,sans-serif;background:var(--bg);color:#222}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:10px 20px;display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:18px}
  nav a{color:#444;text-decoration:none;margin:0 10px;padding:6px 2px;font-weight:600}
  nav a.active{color:var(--brand);border-bottom:2px solid var(--brand)}
  .container{padding:22px;max-width:1100px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
  #drop-zone{padding:48px 20px;text-align:center;color:#555;border:2px dashed var(--border);border-radius:10px;background:#fff;cursor:pointer}
  #drop-zone:hover{border-color:var(--brand)}
  #output{margin-top:18px}
  .day-block{position:relative;margin:16px 0;padding:14px 16px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .day-header{font-weight:700;color:var(--brand);margin-bottom:6px}
  .category{margin:4px 0}
  .copy-btn{position:absolute;right:14px;top:12px;background:var(--copy);color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer}
  .copy-btn:hover{filter:brightness(.95)}
  .muted{color:var(--muted);font-size:13px}
  .rules-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .rule-card{padding:14px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .rule-card h4{margin:0 0 8px 0}
  textarea{width:100%;min-height:70px;border:1px solid var(--border);border-radius:8px;padding:8px;resize:vertical;font-family:inherit}
  select{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px;background:#fff}
  table{border-collapse:collapse;width:100%;margin-top:10px}
  th,td{border:1px solid var(--border);padding:8px;text-align:left}
  th{background:var(--brand);color:#fff}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px 10px;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.good{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
  .row{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .right{margin-left:auto}
  .small{font-size:12px}
  .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin:2px 6px 2px 0;background:#f0f6ff;color:#0a4fa6;font-size:12px}
  #checklist > div{display:flex;align-items:center;gap:8px;margin:6px 0}
  #emails input, #emails textarea{width:100%;margin:6px 0;padding:8px;border:1px solid var(--border);border-radius:8px;font-family:inherit}
  #reset-cache{background:var(--warn);color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600}
  #reset-cache:hover{background:#a55a00}
  .email-model{background:var(--card);padding:12px;margin-bottom:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.08);display:flex;flex-direction:column;gap:6px}
  .email-model input,.email-model textarea{font-family:inherit;font-size:14px;padding:8px;border:1px solid var(--border);border-radius:6px;width:100%}
  .email-actions{display:flex;gap:8px;margin-top:8px}
</style>
</head>
<body>
  <header>
    <h1>AAR SoirÃ©e â€” Live Rules V13</h1>
    <button id="reset-cache">ğŸ”„ RÃ©initialiser</button>
    <nav>
      <a href="#" id="tab-home" class="active">ğŸ  Home</a>
      <a href="#" id="tab-rules">âš™ï¸ RÃ¨gles</a>
      <a href="#" id="tab-check">ğŸ“‹ Checklist</a>
      <a href="#" id="tab-mails">âœ‰ï¸ Emails</a>
    </nav>
  </header>

  <!-- HOME -->
  <div class="container" id="view-home">
    <div class="card" id="drop-zone">
      <p>ğŸ“‚ Glisse ton fichier <b>arrivees.xls</b> / <b>.xlsx</b> / <b>.csv</b> ici ou clique pour le sÃ©lectionner</p>
      <input type="file" id="file-input" accept=".xls,.xlsx,.csv" style="display:none" />
      <p class="muted">Colonnes attendues : <i>Nom / Adultes / Enfants / Commentaire / Date</i><br/>Multi-jours acceptÃ© : regroupement par date + bouton ğŸ“‹ Copier par jour.</p>
    </div>
    <div id="output"></div>
  </div>

  <!-- CHECKLIST -->
  <div class="container" id="view-check" style="display:none">
    <h2>Checklist shift du soir</h2>
    <div id="checklist"></div>
    <textarea id="memo" placeholder="MÃ©mo du soir (sauvegardÃ© automatiquement)"></textarea>
    <button id="reset-check" class="btn warn" style="margin-top:10px">ğŸ§¹ RÃ©initialiser checklist</button>
  </div>

  <!-- EMAILS -->
  <div class="container" id="view-mails" style="display:none">
    <h2>ModÃ¨les dâ€™emails</h2>
    <div id="emails"></div>
    <div class="btn-row">
      <button id="add-mail" class="btn">â• Ajouter un modÃ¨le</button>
      <button id="reset-mails" class="btn warn">ğŸ§¹ RÃ©initialiser</button>
    </div>
  </div>

  <!-- RULES -->
  <div class="container" id="view-rules" style="display:none">
    <div class="row">
      <h2 style="margin:0">RÃ¨gles</h2>
      <div class="right small muted" id="rules-status">RÃ¨gles chargÃ©es</div>
    </div>
    <div class="rule-card" style="margin:14px 0">
      <h3 style="margin:0 0 8px 0">RÃ¨gles dâ€™ouverture de sofa (9 compositions)</h3>
      <table>
        <thead><tr><th>Composition</th><th>Action</th></tr></thead>
        <tbody id="sofa-rules-body"></tbody>
      </table>
    </div>
    <div class="rules-grid">
      <div class="rule-card"><h4>ğŸ¼ LIT BÃ‰BÃ‰</h4><textarea id="kw-baby"></textarea></div>
      <div class="rule-card"><h4>ğŸ”— COMMUNIQUANTE</h4><textarea id="kw-comm"></textarea></div>
      <div class="rule-card"><h4>â° DAY USE</h4><textarea id="kw-dayuse"></textarea></div>
      <div class="rule-card"><h4>â° ARRIVÃ‰E PRIORITAIRE</h4><textarea id="kw-early"></textarea></div>
    </div>
    <div class="btn-row">
      <button class="btn good" id="btn-save">ğŸ’¾ Mettre Ã  jour les rÃ¨gles</button>
      <button class="btn" id="btn-export">ğŸ“¤ Exporter</button>
      <label class="btn">ğŸ“¥ Importer<input type="file" id="import-file" accept="application/json" style="display:none" /></label>
      <button class="btn warn" id="btn-reset">â†º RÃ©tablir valeurs par dÃ©faut</button>
    </div>
  </div>

<script>
/* ---------- Helpers ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const byId = id => document.getElementById(id);

function stripAccentsLower(s){
  return s?.toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'') || '';
}
function parseList(t){return t.split(',').map(x=>stripAccentsLower(x).trim()).filter(Boolean);}
function buildKeywordRegex(list){
  const esc = s=>s
    .replace(/[.*+?^${}()|[\]\\]/g,'\\$&')
    .replace(/\s+/g,'\\s*'); // tolÃ¨re espaces ou sÃ©parateurs
  const p = list.map(esc).join('|');
  return p ? new RegExp(`\\b(${p})\\b`, 'i') : null;
}
function smartDateKey(d){
  const s = (d??'').toString().trim();
  if(!s || s==='Non datÃ©') return {key:'9999-12-31',label:'Non datÃ©'};
  const m1=s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
  if(m1){const[_,dd,mm,yyyy]=m1;return{key:`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`,label:s};}
  const m2=s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
  if(m2){const[_,yyyy,mm,dd]=m2;return{key:`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`,label:s};}
  return {key:s,label:s};
}

/* ---------- NAVIGATION ---------- */
const tabs = { home: byId('tab-home'), rules: byId('tab-rules'), check: byId('tab-check'), mails: byId('tab-mails') };
const views = { home: byId('view-home'), rules: byId('view-rules'), check: byId('view-check'), mails: byId('view-mails') };
function showTab(t){
  Object.values(views).forEach(v=>v.style.display='none');
  Object.values(tabs).forEach(x=>x.classList.remove('active'));
  views[t].style.display='block';
  tabs[t].classList.add('active');
}
tabs.home.onclick=e=>{e.preventDefault();showTab('home')};
tabs.rules.onclick=e=>{e.preventDefault();showTab('rules')};
tabs.check.onclick=e=>{e.preventDefault();showTab('check')};
tabs.mails.onclick=e=>{e.preventDefault();showTab('mails')};
showTab('home');

/* ---------- RULES (LS + UI) ---------- */
const DEFAULTS={
  keywords:{
    baby:["lit bb","lit bebe","lit bÃ©bÃ©","baby","cot","crib"],
    comm:["comm","connecte","connectÃ©","connected","communic"],
    dayuse:["day use","dayuse"],
    early:["early","prioritaire","11h","checkin","check-in","arrivee prioritaire"]
  },
  sofa:{
    "1A+0E":"0","1A+1E":"1","1A+2E":"2","1A+3E":"2",
    "2A+0E":"0","2A+1E":"1","2A+2E":"2",
    "3A+0E":"1","3A+1E":"2"
  }
};
const LS_RULES='aar_soiree_rules_v2';
let RULES = loadRules();
function loadRules(){
  try{
    const r = localStorage.getItem(LS_RULES);
    if(!r) return JSON.parse(JSON.stringify(DEFAULTS));
    const o = JSON.parse(r);
    return {
      keywords:{...DEFAULTS.keywords,...(o.keywords||{})},
      sofa:{...DEFAULTS.sofa,...(o.sofa||{})}
    };
  }catch(e){ return JSON.parse(JSON.stringify(DEFAULTS)); }
}
function saveRules(){ localStorage.setItem(LS_RULES, JSON.stringify(RULES)); }
function renderSofaTable(){
  const body = byId('sofa-rules-body');
  body.innerHTML='';
  Object.entries(RULES.sofa).forEach(([comp,act])=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=comp;
    const td2=document.createElement('td');
    const sel=document.createElement('select');
    ['0','1','2'].forEach(v=>{
      const opt=document.createElement('option');
      opt.value=v; opt.textContent= (v==='0'?'Sofa fermÃ©': v==='1'?'1 sofa':'2 sofa');
      if(v===act) opt.selected=true;
      sel.appendChild(opt);
    });
    sel.onchange=()=>{ RULES.sofa[comp]=sel.value; saveRules(); };
    td2.appendChild(sel);
    tr.append(td1,td2);
    body.appendChild(tr);
  });
}
function populateKeywordAreas(){
  byId('kw-baby').value=(RULES.keywords.baby||[]).join(', ');
  byId('kw-comm').value=(RULES.keywords.comm||[]).join(', ');
  byId('kw-dayuse').value=(RULES.keywords.dayuse||[]).join(', ');
  byId('kw-early').value=(RULES.keywords.early||[]).join(', ');
}
function readKeywordAreasToRules(){
  RULES.keywords.baby = parseList(byId('kw-baby').value||'');
  RULES.keywords.comm = parseList(byId('kw-comm').value||'');
  RULES.keywords.dayuse = parseList(byId('kw-dayuse').value||'');
  RULES.keywords.early = parseList(byId('kw-early').value||'');
}
function compileRegex(){
  return {
    baby: buildKeywordRegex(RULES.keywords.baby),
    comm: buildKeywordRegex(RULES.keywords.comm),
    dayuse: buildKeywordRegex(RULES.keywords.dayuse),
    early: buildKeywordRegex(RULES.keywords.early),
  };
}
renderSofaTable();
populateKeywordAreas();
byId('btn-save').onclick=()=>{
  readKeywordAreasToRules(); saveRules();
  byId('rules-status').textContent='RÃ¨gles mises Ã  jour âœ”';
  setTimeout(()=>byId('rules-status').textContent='RÃ¨gles chargÃ©es',1500);
};
byId('btn-reset').onclick=()=>{
  RULES = JSON.parse(JSON.stringify(DEFAULTS));
  saveRules(); renderSofaTable(); populateKeywordAreas();
  byId('rules-status').textContent='Valeurs par dÃ©faut restaurÃ©es âœ”';
  setTimeout(()=>byId('rules-status').textContent='RÃ¨gles chargÃ©es',1500);
};
byId('btn-export').onclick=()=>{
  const blob=new Blob([JSON.stringify(RULES,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='aar_rules.json'; a.click();
  URL.revokeObjectURL(a.href);
};
byId('import-file').addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const obj=JSON.parse(ev.target.result);
      RULES = {keywords:{...DEFAULTS.keywords,...obj.keywords}, sofa:{...DEFAULTS.sofa,...obj.sofa}};
      saveRules(); renderSofaTable(); populateKeywordAreas();
      byId('rules-status').textContent='RÃ¨gles importÃ©es âœ”';
      setTimeout(()=>byId('rules-status').textContent='RÃ¨gles chargÃ©es',1500);
    }catch(err){ alert('Fichier JSON invalide'); }
  };
  reader.readAsText(f);
});

/* ---------- CHECKLIST (Ã©ditable + mÃ©mo haut) ---------- */
const LS_CHECK='aar_checklist_v2';
const LS_MEMO='aar_memo_v2';
const checklistEl=byId('checklist');
const memoEl=byId('memo');
memoEl.style.minHeight='400px';

const checklistDefault=[
  "VÃ©rifier la propretÃ© du hall + journaux + musique",
  "Compter le fond de caisse",
  "ContrÃ´ler et prÃ©parer les arrivÃ©es du lendemain",
  "ContrÃ´ler les garanties Ã  23h",
  "ClÃ´turer la caisse journaliÃ¨re"
];
let checklist=JSON.parse(localStorage.getItem(LS_CHECK)||'null')||checklistDefault.map(t=>({text:t,done:false}));
function saveChecklist(){localStorage.setItem(LS_CHECK,JSON.stringify(checklist));}
function renderChecklist(){
  checklistEl.innerHTML='';
  checklist.forEach((item,i)=>{
    const row=document.createElement('div');
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=item.done;
    cb.onchange=()=>{checklist[i].done=cb.checked;saveChecklist();};
    const input=document.createElement('input'); input.type='text'; input.value=item.text; input.style.flex='1';
    input.oninput=()=>{checklist[i].text=input.value;saveChecklist();};
    const del=document.createElement('button'); del.textContent='â–'; del.style.border='none'; del.style.background='transparent'; del.style.cursor='pointer';
    del.onclick=()=>{checklist.splice(i,1);saveChecklist();renderChecklist();};
    row.append(cb,input,del);
    checklistEl.appendChild(row);
  });
  const add=document.createElement('button'); add.textContent='â• Ajouter une tÃ¢che'; add.className='btn'; add.style.marginTop='10px';
  add.onclick=()=>{checklist.push({text:'',done:false});saveChecklist();renderChecklist();};
  checklistEl.appendChild(add);
}
byId('reset-check').onclick=()=>{
  checklist=checklistDefault.map(t=>({text:t,done:false}));
  saveChecklist(); renderChecklist();
};
memoEl.value=localStorage.getItem(LS_MEMO)||'';
memoEl.oninput=()=>localStorage.setItem(LS_MEMO,memoEl.value);
renderChecklist();

/* ---------- HOME: Upload + PARSING PAR BLOCS (V12) INTÃ‰GRÃ‰ ---------- */
const dropZone = byId('drop-zone');
const fileInput = byId('file-input');
dropZone.addEventListener('click', ()=> fileInput.click());
['dragenter','dragover'].forEach(ev=>dropZone.addEventListener(ev, e=>{e.preventDefault(); dropZone.style.borderColor='var(--brand)';}));
['dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev, e=>{e.preventDefault(); dropZone.style.borderColor='var(--border)';}));
dropZone.addEventListener('drop', e=>{
  const f = e.dataTransfer.files?.[0]; if(f) handleFile(f);
});
fileInput.addEventListener('change', e=>{
  const f = e.target.files?.[0]; if(f) handleFile(f);
});

/* --- CSV utils (respect guillemets) --- */
function splitCSV(line, sep=';'){
  const out=[]; let cur=''; let inQuotes=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i], nxt=line[i+1];
    if(ch==='"'){
      if(inQuotes && nxt === '"'){ cur+='"'; i++; }
      else { inQuotes=!inQuotes; }
    }else if(ch===sep && !inQuotes){
      out.push(cur); cur='';
    }else{
      cur+=ch;
    }
  }
  out.push(cur);
  return out.map(s=>s.trim().replace(/^"|"$/g,''));
}

/* --- DÃ©limitation blocs client (regex majuscules) --- */
const regexClientStart = /^"[A-ZÃ‰ÃˆÃ€Ã‚ÃŠÃÃ”Ã›Ã„Ã‹ÃÃ–ÃœÃ‡][^;]+";/;

/* Parse FOLS: rÃ©cupÃ¨re header + blocs (premiÃ¨re ligne = header) */
function parseCsvHeaderAndBlocks(text){
  const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.trim()!=='');
  if(!lines.length) return {header:[], blocks:[]};
  const header = splitCSV(lines[0], ';');
  const blocks=[];
  let current=null;

  for(let i=1;i<lines.length;i++){
    const line = lines[i];
    if(regexClientStart.test(line)){
      if(current) blocks.push(current);
      current = { firstLine: line, extra: [] };
    }else{
      if(current) current.extra.push(line);
    }
  }
  if(current) blocks.push(current);
  return {header, blocks};
}

/* Construit un "row object" mappÃ© par header + un texte fusionnÃ© pour keywords */
function buildRowsFromBlocks(header, blocks){
  const rows=[];
  for(const b of blocks){
    const cells = splitCSV(b.firstLine, ';');
    const obj = {};
    header.forEach((h,idx)=>{ obj[h] = (cells[idx] ?? ''); });

    const mergedText = [b.firstLine, ...(b.extra||[])].join(' ');
    rows.push({ __text: mergedText, __first: b.firstLine, ...obj });
  }
  return rows;
}

/* pick: trouve la 1Ã¨re clÃ© existante parmi plusieurs alias */
function pick(row, aliases){
  const keys = Object.keys(row);
  for (const alias of aliases){
    const rx = new RegExp('^' + alias.replace(/\s+/g,'\\s*').replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '$', 'i');
    const k = keys.find(kk => rx.test(kk));
    if (k && row[k] !== undefined && row[k] !== '') return row[k];
  }
  return '';
}

/* Dates: num excel / yyyy-mm-dd / dd-mm-yyyy */
function parseFolsDateCell(v) {
  if (v == null || v === '') return null;
  if (v instanceof Date && !isNaN(v)) {
    return new Date(Date.UTC(v.getFullYear(), v.getMonth(), v.getDate()));
  }
  if (typeof v === 'number') {
    const base = new Date(Date.UTC(1899, 11, 30));
    const d = new Date(base.getTime() + v * 86400000);
    return isNaN(d) ? null : d;
  }
  const s = String(v).trim();
  let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
  if (m) { const dd=+m[1], mm=+m[2], yyyy=+m[3]; return new Date(Date.UTC(yyyy, mm-1, dd)); }
  m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (m) { const yyyy=+m[1], mm=+m[2], dd=+m[3]; return new Date(Date.UTC(yyyy, mm-1, dd)); }
  return null;
}
function toFrLabel(dObj) {
  const jours = ['dimanche','lundi','mardi','mercredi','jeudi','vendredi','samedi'];
  const mois  = ['janvier','fÃ©vrier','mars','avril','mai','juin','juillet','aoÃ»t','septembre','octobre','novembre','dÃ©cembre'];
  const j = jours[dObj.getUTCDay()];
  const jj = String(dObj.getUTCDate()).padStart(2,'0');
  const mm = mois[dObj.getUTCMonth()];
  const yyyy = dObj.getUTCFullYear();
  return `${j} ${jj} ${mm} ${yyyy}`;
}

/* --- HANDLE FILE: CSV natif ou XLS/XLSX -> CSV puis parsing blocs --- */
function handleFile(file){
  const isCSV = /\.csv$/i.test(file.name);
  const reader = new FileReader();

  reader.onload = e=>{
    let csvText = '';

    if (isCSV){
      csvText = e.target.result;
    } else {
      // XLS/XLSX -> SheetJS -> CSV (sÃ©parateur ;)
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type:'array', cellDates:true, cellNF:false, cellText:false });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      csvText = XLSX.utils.sheet_to_csv(sheet, { FS: ';' });
    }

    processCsvText(csvText);
  };

  if (isCSV) reader.readAsText(file, 'utf-8');
  else reader.readAsArrayBuffer(file);
}

/* --- Pipeline blocs -> rows -> rendu (AFFICHAGE IDENTIQUE AU LIVE) --- */
function processCsvText(csvText){
  const {header, blocks} = parseCsvHeaderAndBlocks(csvText);
  const rows = buildRowsFromBlocks(header, blocks);
  renderArrivalsFOLS_fromRows(rows);
}

/* --- Rendu principal (identique au live, mais en s'appuyant sur les blocs) --- */
function renderArrivalsFOLS_fromRows(rows){
  const out = byId('output');
  out.innerHTML = '';

  const rx = compileRegex(); // regex mots-clÃ©s selon RULES
  const grouped = {};

  let lastKey = null;
  let lastLabel = null;

  rows.forEach(r => {
    // Nom court lisible (ne PAS coller le texte complet)
    const nameRaw = String(
      pick(r, ['GUES_NAME','GUEST_NAME','Nom','Client','NAME']) ||
      // fallback: premiÃ¨re cellule de la ligne d'origine
      splitCSV(r.__first || '', ';')[0] || ''
    );

    let nameParts = nameRaw.trim().split(/\s+/);
    let shortName = '';
    if (nameParts.length > 1) {
      shortName = nameParts[0].length < 3 ? `${nameParts[0]} ${nameParts[1]}` : nameParts[0];
    } else {
      shortName = nameParts[0] || '';
    }
    const name = (shortName || '').toUpperCase().trim();
    if (!name) return;

    const adu = parseInt(
      pick(r, ['NB_OCC_AD','Adultes','ADULTES','ADULTS','A','ADU']) || '0'
    ) || 0;

    const enf = parseInt(
      pick(r, ['NB_OCC_CH','Enfants','ENFANTS','CHILDREN','E','CH']) || '0'
    ) || 0;

    // Texte fusionnÃ© pour recherche mots-clÃ©s (provenant du bloc complet)
    let comment = (r.__text || '');
    comment = stripAccentsLower(
      comment.replace(/<[^>]*>/g,' ')
    )
    .replace(/["*()]/g, ' ')          // enlÃ¨ve guillemets, astÃ©risques, parenthÃ¨ses
    .replace(/s\/intern[:\s-]*/g, ' ') // supprime prÃ©fixe "S/INTERN:"
    .replace(/[^\p{L}\p{N}\s\+]/gu, ' ')
    .replace(/\s+/g, ' ')
    .trim();

    // Date: on privilÃ©gie les colonnes, sinon on tente dâ€™extraire du bloc texte
    let dObj = parseFolsDateCell(
      pick(r, ['PSER_DATE','PSER DATE','DATE_ARR','DATE ARR','Date','DATE','Arrival Date','ARRIVAL_DATE']) || ''
    );
    if (!dObj) {
      const m = (r.__text||'').match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
      if (m) {
        const dd=+m[1], mm=+m[2], yyyy=+m[3];
        dObj = new Date(Date.UTC(yyyy, mm-1, dd));
      }
    }

    let dateKey, dateLabel;
    if (!dObj && lastKey) {
      dateKey = lastKey;
      dateLabel = lastLabel;
    } else if (dObj) {
      const key = dObj.toISOString().split('T')[0];
      const label = toFrLabel(dObj);
      lastKey = key;
      lastLabel = label;
      dateKey = key;
      dateLabel = label;
    } else {
      // aucune date -> on peut ignorer ou regrouper "Non datÃ©"
      const {key,label} = smartDateKey('Non datÃ©');
      dateKey = key; dateLabel = label;
    }

    if (!grouped[dateKey]) {
      grouped[dateKey] = {
        label: dateLabel,
        "2_sofa": [], "1_sofa": [],
        "lit_bebe": [], "comm": [],
        "dayuse": [], "early": []
      };
    }

    const sofaKey = `${adu}A+${enf}E`;
    const sofa = (RULES.sofa && RULES.sofa[sofaKey]) || "0";
    if (sofa === "1") grouped[dateKey]["1_sofa"].push(name);
    if (sofa === "2") grouped[dateKey]["2_sofa"].push(name);

    if (rx.baby && rx.baby.test(comment)) grouped[dateKey]["lit_bebe"].push(name);
    if (rx.comm && rx.comm.test(comment)) grouped[dateKey]["comm"].push(name);
    if (rx.dayuse && rx.dayuse.test(comment)) grouped[dateKey]["dayuse"].push(name);
    if (rx.early && rx.early.test(comment)) grouped[dateKey]["early"].push(name);
  });

  const keys = Object.keys(grouped).sort();
  if (!keys.length){
    out.innerHTML = '<p class="muted">Aucune donnÃ©e valide dÃ©tectÃ©e.</p>';
    return;
  }

  // --- Affichage IDENTIQUE au live (1 SOFA / 2 SOFA / LIT BÃ‰BÃ‰ / etc.) ---
  keys.forEach(k => {
    const data = grouped[k];
    const blk = document.createElement('div');
    blk.className = 'day-block';

    const h = document.createElement('div');
    h.className = 'day-header';
    h.textContent = `ğŸ“… ${data.label}`;

    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'ğŸ“‹ Copier';

    const copyText = [];
    if (data["2_sofa"].length) copyText.push(`ğŸ›‹ï¸ 2 SOFA : ${data["2_sofa"].join(', ')}`);
    if (data["1_sofa"].length) copyText.push(`ğŸ›‹ï¸ 1 SOFA : ${data["1_sofa"].join(', ')}`);
    if (data["lit_bebe"].length) copyText.push(`ğŸ¼ LIT BÃ‰BÃ‰ : ${data["lit_bebe"].join(', ')}`);
    if (data["comm"].length)     copyText.push(`ğŸ”— COMMUNIQUANTE : ${data["comm"].join(', ')}`);
    if (data["dayuse"].length)   copyText.push(`â° DAY USE : ${data["dayuse"].join(', ')}`);
    if (data["early"].length)    copyText.push(`â° ARRIVÃ‰E PRIORITAIRE : ${data["early"].join(', ')}`);

    btn.onclick = () => {
      navigator.clipboard.writeText(copyText.join('\n'));
      btn.textContent = 'âœ” CopiÃ©';
      setTimeout(()=> btn.textContent = 'ğŸ“‹ Copier', 1200);
    };

    const ul = document.createElement('div');
    ["2_sofa","1_sofa","lit_bebe","comm","dayuse","early"].forEach(cat=>{
      if (data[cat].length){
        const p = document.createElement('div');
        const label =
          cat==="lit_bebe" ? "ğŸ¼ LIT BÃ‰BÃ‰" :
          cat==="comm"     ? "ğŸ”— COMMUNIQUANTE" :
          cat==="dayuse"   ? "â° DAY USE" :
          cat==="early"    ? "â° ARRIVÃ‰E PRIORITAIRE" :
          cat==="2_sofa"   ? "ğŸ›‹ï¸ 2 SOFA" : "ğŸ›‹ï¸ 1 SOFA";
        p.textContent = `${label} : ${data[cat].join(', ')}`;
        ul.appendChild(p);
      }
    });

    blk.append(h, btn, ul);
    out.appendChild(blk);
  });
}

/* RÃ©initialisation cache local */
document.getElementById('reset-cache').addEventListener('click', () => {
  if (confirm("Voulez-vous rÃ©initialiser toutes les donnÃ©es locales ?")) {
    localStorage.clear(); sessionStorage.clear(); location.reload();
  }
});
</script>

<script>
/* ========== EMAILS (module autonome, inchangÃ©) ========== */
(function(){
  const LS_MAILS = 'aar_mail_models_v3';
  const DEFAULT_MAILS = [
    { name: "Confirmation rÃ©servation", to: "client@exemple.com", subject: "Confirmation de votre rÃ©servation au Novotel", body: "Bonjour,\nNous confirmons votre rÃ©servation au Novotel...\nCordialement," },
    { name: "Relance garantie", to: "", subject: "Garantie de votre rÃ©servation", body: "Bonjour,\nVotre rÃ©servation n'est pas encore garantie.\nMerci de nous recontacter.\nCordialement," }
  ];

  if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init); }
  else { init(); }

  function init(){
    const emailsEl  = document.getElementById('emails');
    const btnAdd    = document.getElementById('add-mail');
    const btnReset  = document.getElementById('reset-mails');

    if (!emailsEl || !btnAdd || !btnReset) return setTimeout(init, 0);

    let mailModels = safeRead(LS_MAILS) || clone(DEFAULT_MAILS);
    save();

    btnAdd.onclick = onAdd;
    btnReset.onclick = onReset;

    render();

    function onAdd(){
      mailModels.push({ name:"", to:"", subject:"", body:"" });
      save(); render();
    }
    function onReset(){
      if (confirm("RÃ©tablir les modÃ¨les d'e-mails par dÃ©faut ?")) {
        mailModels = clone(DEFAULT_MAILS);
        save(); render();
      }
    }
    function onDelete(i){
      if (confirm("Supprimer ce modÃ¨le ?")) {
        mailModels.splice(i,1);
        save(); render();
      }
    }
    function onCopy(m, btn){
      const fullText = `Ã€: ${m.to || '(non renseignÃ©)'}\nObjet: ${m.subject || '(aucun)'}\n\n${m.body || ''}`;
      navigator.clipboard.writeText(fullText).then(()=>{
        const old = btn.textContent;
        btn.textContent = 'âœ” CopiÃ©';
        setTimeout(()=>btn.textContent = old, 1200);
      });
    }
    function render(){
      emailsEl.innerHTML = '';
      mailModels.forEach((m,i)=>{
        const wrap = document.createElement('div');
        wrap.className = 'email-model';
        wrap.innerHTML = `
          <input type="text" class="email-name" placeholder="Nom du modÃ¨le" value="${escapeHTML(m.name||'')}">
          <input type="email" class="email-to" placeholder="Adresse destinataire (ex : client@exemple.com)" value="${escapeHTML(m.to||'')}">
          <input type="text" class="email-subject" placeholder="Objet du mail" value="${escapeHTML(m.subject||'')}">
          <textarea class="email-body" rows="5" placeholder="Contenu du mail">${escapeHTML(m.body||'')}</textarea>
          <div class="email-actions">
            <button class="btn good btn-copy">ğŸ“‹ Copier</button>
            <button class="btn warn btn-delete">ğŸ—‘ï¸ Supprimer</button>
          </div>
        `;
        const inName = wrap.querySelector('.email-name');
        const inTo   = wrap.querySelector('.email-to');
        const inSub  = wrap.querySelector('.email-subject');
        const inBody = wrap.querySelector('.email-body');
        const bCopy  = wrap.querySelector('.btn-copy');
        const bDel   = wrap.querySelector('.btn-delete');

        inName.oninput = e => { mailModels[i].name = e.target.value; save(); };
        inTo.oninput   = e => { mailModels[i].to   = e.target.value; save(); };
        inSub.oninput  = e => { mailModels[i].subject = e.target.value; save(); };
        inBody.oninput = e => { mailModels[i].body = e.target.value; save(); };

        bCopy.onclick = () => onCopy(mailModels[i], bCopy);
        bDel.onclick  = () => onDelete(i);

        emailsEl.appendChild(wrap);
      });
    }
    function save(){ localStorage.setItem(LS_MAILS, JSON.stringify(mailModels)); }
    function safeRead(key){
      try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : null; }
      catch(_){ return null; }
    }
    function clone(x){ return JSON.parse(JSON.stringify(x)); }
    function escapeHTML(s){
      return (s||'').toString()
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
  }
})();
</script>
</body>
</html>
